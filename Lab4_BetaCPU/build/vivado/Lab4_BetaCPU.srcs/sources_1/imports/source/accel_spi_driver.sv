/*
    This file was generated automatically by Alchitry Labs 2.0.30-BETA.
    Do not edit this file directly. Instead edit the original Lucid source.
    This is a temporary file and any changes made to it will be destroyed.
*/

module accel_spi_driver (
        input wire clk,
        input wire rst,
        input wire [7:0] out_byte,
        input wire enable,
        input wire miso,
        output reg mosi,
        output reg scl,
        output reg csx,
        output reg [7:0] in_byte,
        output reg next_byte
    );
    logic [4:0] D_clock_ctr_d, D_clock_ctr_q = 0;
    logic [2:0] D_bit_ptr_d, D_bit_ptr_q = 0;
    logic [7:0] D_out_byte_cache_d, D_out_byte_cache_q = 0;
    logic [7:0] D_in_byte_cache_d, D_in_byte_cache_q = 0;
    logic [7:0] D_in_byte_output_buffer_d, D_in_byte_output_buffer_q = 0;
    logic D_active_d, D_active_q = 0;
    logic D_mosi_enable_d, D_mosi_enable_q = 0;
    logic D_rw_d, D_rw_q = 0;
    logic spi_clock;
    always @* begin
        D_out_byte_cache_d = D_out_byte_cache_q;
        D_active_d = D_active_q;
        D_clock_ctr_d = D_clock_ctr_q;
        D_mosi_enable_d = D_mosi_enable_q;
        D_bit_ptr_d = D_bit_ptr_q;
        D_in_byte_cache_d = D_in_byte_cache_q;
        D_rw_d = D_rw_q;
        D_in_byte_output_buffer_d = D_in_byte_output_buffer_q;
        
        if (enable && ~D_active_q) begin
            D_out_byte_cache_d = out_byte;
            D_active_d = 1'h1;
        end
        in_byte = D_in_byte_output_buffer_q;
        if (D_active_q) begin
            D_clock_ctr_d = D_clock_ctr_q + 1'h1;
            spi_clock = D_clock_ctr_q[4];
            scl = spi_clock;
            csx = 1'h0;
            next_byte = 1'h0;
            if (D_bit_ptr_q == 1'h0 && D_clock_ctr_q == 1'h0) begin
                
            end
            if (D_clock_ctr_q == 4'he) begin
                D_mosi_enable_d = !D_mosi_enable_q;
            end
            if (D_clock_ctr_q == 5'h1e) begin
                D_mosi_enable_d = !D_mosi_enable_q;
            end
            if ((&D_clock_ctr_q)) begin
                D_bit_ptr_d = D_bit_ptr_q + 1'h1;
                D_out_byte_cache_d = {D_out_byte_cache_q[6:1'h0], 1'h0};
            end
            if (D_rw_q && D_clock_ctr_q == 5'h14) begin
                D_in_byte_cache_d = {D_in_byte_cache_q[6:1'h0], miso};
            end
            mosi = 1'h0;
            if (D_mosi_enable_q && ~D_rw_q) begin
                if (D_out_byte_cache_q[7]) begin
                    mosi = 1'h1;
                end
            end
            if (D_bit_ptr_q == 3'h7 && ~D_rw_q) begin
                if ((&D_clock_ctr_q)) begin
                    D_rw_d = 1'h1;
                end
            end
            if (D_bit_ptr_q == 3'h7 && D_rw_q) begin
                if (D_clock_ctr_q == 5'h16) begin
                    D_in_byte_output_buffer_d = D_in_byte_cache_q;
                end
                if ((&D_clock_ctr_q)) begin
                    D_rw_d = 1'h0;
                    D_active_d = 1'h0;
                    D_in_byte_cache_d = 1'h0;
                end
            end
        end else begin
            csx = 1'h1;
            spi_clock = 1'h0;
            scl = spi_clock;
            next_byte = 1'h1;
            mosi = 1'h0;
            D_in_byte_cache_d = 1'h0;
        end
    end
    
    
    always @(posedge (clk)) begin
        if ((rst) == 1'b1) begin
            D_clock_ctr_q <= 0;
            D_bit_ptr_q <= 0;
            D_out_byte_cache_q <= 0;
            D_in_byte_cache_q <= 0;
            D_in_byte_output_buffer_q <= 0;
            D_active_q <= 0;
            D_mosi_enable_q <= 0;
            D_rw_q <= 0;
        end else begin
            D_clock_ctr_q <= D_clock_ctr_d;
            D_bit_ptr_q <= D_bit_ptr_d;
            D_out_byte_cache_q <= D_out_byte_cache_d;
            D_in_byte_cache_q <= D_in_byte_cache_d;
            D_in_byte_output_buffer_q <= D_in_byte_output_buffer_d;
            D_active_q <= D_active_d;
            D_mosi_enable_q <= D_mosi_enable_d;
            D_rw_q <= D_rw_d;
        end
    end
endmodule